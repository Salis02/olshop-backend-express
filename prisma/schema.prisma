generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum ProductStatus {
  draft
  active
  archived
}

enum PaymentStatus {
  pending
  success
  failed
  refunded
}

enum FulfillmentStatus {
  unfulfilled
  processing
  shipped
  delivered
  cancelled
}

enum DiscountType {
  percentage
  fixed
}

enum EventStatus {
  upcoming
  active
  ended
}

model Role {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  users       User[]
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
}

model User {
  uuid              String    @id @default(uuid())
  role_id           Int
  name              String
  email             String    @unique
  password          String
  phone             String?
  email_verified_at DateTime?
  remember_token    String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  deleted_at        DateTime?

  role             Role          @relation(fields: [role_id], references: [id])
  addresses        Address[]
  products_created Product[]     @relation("UserCreatedProducts")
  products_updated Product[]     @relation("UserUpdatedProducts")
  carts            Cart[]
  orders           Order[]
  reviews          Review[]
  wishlists        Wishlist[]
  activity_logs    ActivityLog[]
}

model Address {
  id             Int      @id @default(autoincrement())
  user_id        String
  label          String
  recipient_name String
  phone          String
  address_line   String
  city           String
  province       String
  postal_code    String
  is_default     Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  user   User    @relation(fields: [user_id], references: [uuid], onDelete: Cascade)
  orders Order[]
}

model Category {
  id          Int       @id @default(autoincrement())
  parent_id   Int?
  name        String
  slug        String    @unique
  description String?
  created_at  DateTime  @default(now())
  updated_at  DateTime  @updatedAt
  deleted_at  DateTime?

  parent   Category?  @relation("CategoryParent", fields: [parent_id], references: [id])
  children Category[] @relation("CategoryParent")
  products Product[]
}

model Product {
  uuid        String        @id @default(uuid())
  category_id Int?
  name        String
  slug        String        @unique
  description String?
  price       Int
  stock       Int
  sku         String
  status      ProductStatus @default(draft)
  created_by  String
  updated_by  String?
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt
  deleted_at  DateTime?

  category    Category?          @relation(fields: [category_id], references: [id], onDelete: SetNull)
  creator     User               @relation("UserCreatedProducts", fields: [created_by], references: [uuid])
  updater     User?              @relation("UserUpdatedProducts", fields: [updated_by], references: [uuid])
  images      ProductImage[]
  variants    ProductVariant[]
  attributes  ProductAttribute[]
  cart_items  CartItem[]
  order_items OrderItem[]
  reviews     Review[]
  wishlists   Wishlist[]
  event_links EventProduct[]
}

model ProductImage {
  id         Int      @id @default(autoincrement())
  product_id String
  path       String
  is_primary Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  product Product @relation(fields: [product_id], references: [uuid], onDelete: Cascade)
}

model ProductVariant {
  id               Int      @id @default(autoincrement())
  product_id       String
  name             String
  price_adjustment Int?
  stock_adjustment Int?
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  product     Product     @relation(fields: [product_id], references: [uuid], onDelete: Cascade)
  cart_items  CartItem[]
  order_items OrderItem[]
}

model ProductAttribute {
  id         Int      @id @default(autoincrement())
  product_id String
  key        String
  value      String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  product Product @relation(fields: [product_id], references: [uuid], onDelete: Cascade)
}

model Cart {
  id         Int      @id @default(autoincrement())
  user_id    String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user  User       @relation(fields: [user_id], references: [uuid], onDelete: Cascade)
  items CartItem[]
}

model CartItem {
  id             Int      @id @default(autoincrement())
  cart_id        Int
  product_id     String
  variant_id     Int?
  quantity       Int
  price_snapshot Int
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  cart    Cart            @relation(fields: [cart_id], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [product_id], references: [uuid])
  variant ProductVariant? @relation(fields: [variant_id], references: [id])
}

model Order {
  uuid                String            @id @default(uuid())
  user_id             String
  order_code          String            @unique
  total_price         Int
  discount_total      Int               @default(0)
  shipping_fee        Int               @default(0)
  grand_total         Int
  payment_status      PaymentStatus
  fulfillment_status  FulfillmentStatus
  shipping_address_id Int
  created_at          DateTime          @default(now())
  updated_at          DateTime          @updatedAt
  deleted_at          DateTime?

  user      User        @relation(fields: [user_id], references: [uuid])
  address   Address     @relation(fields: [shipping_address_id], references: [id])
  items     OrderItem[]
  payments  Payment[]
  shipments Shipment[]
}

model OrderItem {
  id         Int      @id @default(autoincrement())
  order_id   String
  product_id String
  variant_id Int?
  quantity   Int
  price      Int
  subtotal   Int
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  order   Order           @relation(fields: [order_id], references: [uuid], onDelete: Cascade)
  product Product         @relation(fields: [product_id], references: [uuid])
  variant ProductVariant? @relation(fields: [variant_id], references: [id])
}

model Payment {
  id           Int           @id @default(autoincrement())
  order_id     String
  provider     String
  reference_no String        @unique
  amount       Int
  status       PaymentStatus
  paid_at      DateTime?
  meta         Json?
  created_at   DateTime      @default(now())
  updated_at   DateTime      @updatedAt

  order Order @relation(fields: [order_id], references: [uuid], onDelete: Cascade)
}

model Shipment {
  id              Int               @id @default(autoincrement())
  order_id        String
  courier         String
  tracking_number String?
  status          FulfillmentStatus
  shipped_at      DateTime?
  delivered_at    DateTime?
  created_at      DateTime          @default(now())
  updated_at      DateTime          @updatedAt

  order Order @relation(fields: [order_id], references: [uuid], onDelete: Cascade)
}

model Review {
  id         Int      @id @default(autoincrement())
  user_id    String
  product_id String
  rating     Int
  comment    String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user    User    @relation(fields: [user_id], references: [uuid])
  product Product @relation(fields: [product_id], references: [uuid])
}

model Wishlist {
  id         Int      @id @default(autoincrement())
  user_id    String
  product_id String
  created_at DateTime @default(now())

  user    User    @relation(fields: [user_id], references: [uuid])
  product Product @relation(fields: [product_id], references: [uuid])
}

model Coupon {
  id            Int          @id @default(autoincrement())
  code          String       @unique
  description   String?
  discount_type DiscountType
  value         Int
  max_usage     Int
  expires_at    DateTime
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt
}

model Event {
  id          Int         @id @default(autoincrement())
  name        String
  slug        String      @unique
  description String?
  start_date  DateTime
  end_date    DateTime
  status      EventStatus
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  deleted_at  DateTime?

  products EventProduct[]
}

model EventProduct {
  id             Int      @id @default(autoincrement())
  event_id       Int
  product_id     String
  discount_value Int
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  event   Event   @relation(fields: [event_id], references: [id], onDelete: Cascade)
  product Product @relation(fields: [product_id], references: [uuid], onDelete: Cascade)
}

model ActivityLog {
  id          Int      @id @default(autoincrement())
  user_id     String
  action      String
  target_type String
  target_id   String
  meta        Json?
  created_at  DateTime @default(now())

  user User @relation(fields: [user_id], references: [uuid])
}
